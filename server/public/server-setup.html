<!DOCTYPE html>
<!-- prettier-ignore -->
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>راهنمای حرفه‌ای نصب سرور نقشه میدون</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/server-setup.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Include Persian font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar">
      <div class="container navbar-container">
        <a href="/" class="logo">میدون مپ</a>
      </div>
    </nav>

    <div class="container">
      <h1>راهنمای نصب سرور نقشه شخصی</h1>

      <section class="service-card">
        <h2>پیش نیازها</h2>
        <ul>
          <li>سرور با حداقل ۴ گیگابایت RAM آزاد و ۱۰ فضای ذخیره سازی (برای نقشه ایران و داده های مرتبط با آن)</li>
          <li>Docker نصب شده باشد</li>
        </ul>
      </section>

      <section class="service-card">
        <h2>دریافت فایل نقشه منطقه مورد نظر</h2>
        <p>برای دریافت فایل OSM منطقه مورد نظر:</p>
        <ol>
          <li>به سایت <a href="https://extract.bbbike.org" target="_blank">extract.bbbike.org</a> مراجعه کنید</li>
          <li>نقشه را به منطقه مورد نظر زوم کنید</li>
          <li>با کشیدن مستطیل محدوده مورد نظر را انتخاب کنید</li>
          <li>قالب "PBF" را انتخاب کنید</li>
          <li>ایمیل خود را وارد و منتظر لینک دانلود بمانید</li>
        </ol>
      </section>

      <section class="service-card">
        <h2>فایل پیکربندی تبدیل (convert.config.json)</h2>
        <p>فایل پیکربندی تبدیل (convert.config.json):</p>
        <code class="api-example">
{
  "layers": {
    "place": { "minzoom": 4, "maxzoom": 14 },
    "poi": { "minzoom": 12, "maxzoom": 14 },
    "poi_detail": { "minzoom": 14, "maxzoom": 14, "write_to": "poi" },
    "housenumber": { "minzoom": 14, "maxzoom": 14 },
    "boundary": {
      "minzoom": 0,
      "maxzoom": 14,
      "simplify_below": 12,
      "simplify_level": 0.0003,
      "simplify_ratio": 2,
      "simplify_algorithm": "visvalingam"
    },
    "waterway": {
      "minzoom": 8,
      "maxzoom": 14,
      "simplify_below": 12,
      "simplify_level": 0.0003,
      "simplify_ratio": 2
    },
    "waterway_detail": { "minzoom": 12, "maxzoom": 14, "write_to": "waterway" },
    "transportation": {
      "minzoom": 8,
      "maxzoom": 14,
      "simplify_below": 13,
      "simplify_level": 0.0003
    },
    "transportation_main": {
      "minzoom": 9,
      "maxzoom": 14,
      "simplify_below": 13,
      "simplify_level": 0.0003,
      "write_to": "transportation"
    },
    "transportation_mid": {
      "minzoom": 11,
      "maxzoom": 14,
      "write_to": "transportation"
    },
    "transportation_detail": {
      "minzoom": 13,
      "maxzoom": 14,
      "write_to": "transportation"
    },
    "transportation_name": { "minzoom": 8, "maxzoom": 14 },
    "transportation_name_mid": {
      "minzoom": 12,
      "maxzoom": 14,
      "write_to": "transportation_name"
    },
    "transportation_name_detail": {
      "minzoom": 14,
      "maxzoom": 14,
      "write_to": "transportation_name"
    },
    "building": { "minzoom": 13, "maxzoom": 14 },
    "water": {
      "minzoom": 6,
      "maxzoom": 14,
      "simplify_below": 12,
      "simplify_length": 1,
      "simplify_ratio": 2
    },
    "water_name": { "minzoom": 14, "maxzoom": 14 },
    "water_name_detail": {
      "minzoom": 14,
      "maxzoom": 14,
      "write_to": "water_name"
    },
    "aeroway": { "minzoom": 11, "maxzoom": 14 },
    "aerodrome_label": { "minzoom": 10, "maxzoom": 14 },
    "park": { "minzoom": 11, "maxzoom": 14 },
    "landuse": { "minzoom": 11, "maxzoom": 14 },
    "landcover": {
      "minzoom": 6,
      "maxzoom": 14,
      "simplify_below": 13,
      "simplify_level": 0.0003,
      "simplify_ratio": 2
    },
    "mountain_peak": { "minzoom": 11, "maxzoom": 14 },
    "country_borders": {
      "minzoom": 0,
      "maxzoom": 14,
      "source": "/data/shapes/ne_10m_admin_0_countries.shp",
      "simplify_below": 8,
      "simplify_level": 0.0001,
      "bounding_box": [-180, -90, 180, 90]
    }
  },
  "settings": {
    "minzoom": 0,
    "maxzoom": 14,
    "basezoom": 14,
    "include_ids": false,
    "name": "Tilemaker example",
    "version": "0.1",
    "description": "Sample vector tiles for Tilemaker",
    "compress": "gzip",
    "bounds": [-180, -90, 180, 90]
  }
}
          </code>
        <p class="note">سپس با دستور زیر فرمت PBF را به MBTILES تبدیل کنید</p>
        <code>
docker run --rm -v $(pwd):/data ghcr.io/systemed/tilemaker:master \
--input /data/iran.osm.pbf \
--output /data/iran.mbtiles \
--config /data/convert.config.json
        </code>
      </section>


      <section class="service-card">
        <h2>استفاده از فونت فارسی</h2>
        <p>برای افزودن فونت فارسی به TileServer GL:</p>
        <ol>
          <li>فونت‌های مورد نظر را ابتدا با مراجعه به آدرس https://maplibre.org/font-maker
            تبدیل کنید</li>
          <li>فونت‌های تبدیل شده را در پوشه fonts/ قرار دهید</li>
          <li>فایل config.json را ویرایش کنید:</li>
          <code class="api-example">
{
  "options": {
    "paths": {
      "fonts": "fonts"
    },
    "serveAllFonts": true
  },
  "data": {
    "your-map": {
      "mbtiles": "tiles.mbtiles"
    }
  }
}
</code>
        </ol>
      </section>

      <section class="service-card">
        <h2>فایل کامل docker-compose.yml</h2>
        
        <div class="service-card">
          <h3>آشنایی با ساختار کلی</h3>
          <code>
version: "3.8"

volumes:
  letsencrypt:
  logs:
  nominatim-data:
  
services:
  traefik:
    image: traefik:latest
    command:
      - "--api.dashboard=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedByDefault=false"
      - "--entryPoints.web.address=:80"
      - "--entryPoints.websecure.address=:443"
      - "--certificatesResolvers.letsencrypt.acme.email=example@email.com"
      - "--certificatesResolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesResolvers.letsencrypt.acme.httpChallenge.entryPoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "letsencrypt:/letsencrypt"
      - "logs:/logs"
    deploy:
      labels:
        - "traefik.enable=true"

  tileserver:
    image: maptiler/tileserver-gl
    volumes:
      - ./config.json:/data/config.json
      - ./fonts:/data/fonts
      - ./data/iran.mbtiles:/data/tiles.mbtiles
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.services.tiles-example.loadbalancer.server.port=8080"
        - "traefik.http.routers.tiles-https-example.entrypoints=https"
        - "traefik.http.routers.tiles-https-example.rule=Host(`tiles.example.com`)"

  osrm-backend:
    image: osrm/osrm-backend
    volumes:
      - ./data:/data
    command: osrm-routed --algorithm mld /data/iran.osrm
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.services.osrm-example.loadbalancer.server.port=5000"
        - "traefik.http.routers.osrm-https-example.entrypoints=https"
        - "traefik.http.routers.osrm-https-example.rule=Host(`osrm.example.com`)"

  nominatim:
    image: mediagis/nominatim:4.2
    volumes:
      - ./data/iran.osm.pbf:/data/iran.osm.pbf
      - nominatim-data:/var/lib/postgresql/14/main
    environment:
      PBF_PATH: /data/iran.osm.pbf
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.services.nominatim-example.loadbalancer.server.port=8080"
        - "traefik.http.routers.nominatim-https-example.entrypoints=https"
        - "traefik.http.routers.nominatim-https-example.rule=Host(`nominatim.example.com`)"

</code>
        </div>

        <div class="service-card">
          <h4>سرویس‌ها (Services)</h4>
          <ul>
            <li><strong>traefik</strong>: سرویس مدیریت ترافیک ورودی و TLS</li>
            <li><strong>tileserver</strong>: ارائه نقشه‌های برداری با سفارشی سازی فونت فارسی</li>
            <li><strong>osrm-backend</strong>: موتور مسیریابی با الگوریتم MLD</li>
            <li><strong>nominatim</strong>: سیستم جستجوی آدرس</li>
          </ul>
        </div>

        <div class="service-card">
          <h3>دستورات اجرا</h3>
          <code class="api-example">
docker swarm init

docker stack deploy -c docker-compose.yml example

</code>
        </div>

        <section class="service-card warning">
          <h2>⚠️ ملاحظات امنیتی مهم</h2>
          <p>
            امنیت این تنظیمات مبتنی بر:
          </p>
          <ul>
            <li>استفاده از تایید هویت دو مرحله‌ای Traefik برای تمام سرویس‌ها</li>
            <li>رمزنگاری تمام ترافیک با TLS 1.3</li>
            <li>بستن پورت‌های مدیریتی به جز 80 و 443</li>
            <li>لاگ تمام درخواست‌ها</li>
            <li>آپدیت خودکار گواهی‌ها</li>
            <li>محدودیت نرخ درخواست (Rate Limiting)</li>
          </ul>
          
          <p>
            این تنظیمات از طریق Docker network internal امکان‌پذیر است. اطمینان حاصل کنید تمام ارتباطات:
          </p>
          <ul>
            <li>با احراز هویت توکن JWT انجام شود</li>
            <li>با محدودیت نرخ (Rate Limiting) همراه باشد</li>
            <li>در لاگ‌ها ثبت شود</li>
          </ul>
        </section>
      </section>


    </div>

    <footer>
      <div class="container">
        <p>© ۱۴۰۴ میدون مپ. تمامی حقوق محفوظ است.</p>
      </div>
    </footer>
  </body>
</html>
